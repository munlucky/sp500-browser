<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S&P 500 실시간 돌파 스캐너</title>
    
    <!-- PWA 설정 (HTTP/HTTPS에서만 동작) -->
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="실시간 S&P 500 변동성 돌파 종목 추천 서비스">
    <meta name="keywords" content="S&P 500, 주식, 스캐너, 변동성, 돌파, 투자">
    <meta name="author" content="S&P 500 Scanner">
    
    <!-- Open Graph -->
    <meta property="og:title" content="S&P 500 실시간 돌파 스캐너">
    <meta property="og:description" content="실시간 S&P 500 변동성 돌파 종목 추천 서비스">
    <meta property="og:type" content="website">
    <meta property="og:url" content="">
    <meta property="og:image" content="icons/icon-512.png">
    
    <!-- 아이콘 -->
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
    
    <!-- 동적 manifest 로드 -->
    <script>
        // HTTP/HTTPS 환경에서만 manifest 로드
        if (location.protocol !== 'file:') {
            const manifestLink = document.createElement('link');
            manifestLink.rel = 'manifest';
            manifestLink.href = 'manifest.json';
            document.head.appendChild(manifestLink);
        }
    </script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://www.alphavantage.co">
    <link rel="preconnect" href="https://finance.yahoo.com">
    
    <!-- 추가 Viewport Meta -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>
    <div class="app">
        <!-- 메인 헤더 -->
        <header class="main-header">
            <div class="header-content">
                <div class="brand-section">
                    <div class="brand-icon">📈</div>
                    <div class="brand-text">
                        <h1 class="brand-title">S&P 500 실시간 스캐너</h1>
                        <p class="brand-subtitle">래리 윌리엄스 변동성 돌파 전략</p>
                    </div>
                </div>
                
                <!-- 실시간 대시보드 -->
                <div class="live-dashboard">
                    <div class="dashboard-card breakout-card">
                        <div class="card-icon">🚀</div>
                        <div class="card-content">
                            <span class="card-number" id="breakoutCount">0</span>
                            <span class="card-label">돌파 종목</span>
                        </div>
                    </div>
                    <div class="dashboard-card waiting-card">
                        <div class="card-icon">⏰</div>
                        <div class="card-content">
                            <span class="card-number" id="waitingCount">0</span>
                            <span class="card-label">대기 종목</span>
                        </div>
                    </div>
                    <div class="dashboard-card scanned-card">
                        <div class="card-icon">📊</div>
                        <div class="card-content">
                            <span class="card-number" id="totalScanned">0</span>
                            <span class="card-label">총 스캔</span>
                        </div>
                    </div>
                    <div class="dashboard-card error-card">
                        <div class="card-icon">⚠️</div>
                        <div class="card-content">
                            <span class="card-number" id="errorCount">0</span>
                            <span class="card-label">오류</span>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- 컨트롤 네비게이션 -->
        <nav class="control-navigation">
            <div class="control-container">
                <!-- 메인 스캔 버튼 -->
                <div class="primary-controls">
                    <button id="scanBtn" class="primary-scan-btn" title="래리 윌리엄스 변동성 돌파 전략으로 전체 스캔">
                        <div class="scan-btn-content">
                            <span class="scan-icon">🚀</span>
                            <div class="scan-text">
                                <span class="scan-title">스마트 스캔 시작</span>
                                <span class="scan-subtitle">S&P 500 돌파 전략 분석</span>
                            </div>
                            <div class="scan-status" id="status">준비됨</div>
                        </div>
                    </button>
                </div>

                <!-- 보조 컨트롤 -->
                <div class="secondary-controls">
                    <!-- 자동 업데이트 토글 -->
                    <button id="autoUpdateToggleBtn" class="control-btn auto-update-btn" title="실시간 가격 자동 업데이트">
                        <span class="ctrl-icon">⏸️</span>
                        <div class="ctrl-content">
                            <span class="ctrl-text">자동 업데이트</span>
                            <span class="ctrl-status" id="autoUpdateStatus">중지됨</span>
                            <span class="ctrl-timer" id="autoUpdateTimer"></span>
                        </div>
                        <div class="ctrl-progress" id="autoUpdateProgress"></div>
                    </button>

                    <!-- 설정 드롭다운 -->
                    <div class="settings-dropdown">
                        <button id="settingsDropdownBtn" class="control-btn settings-btn" title="설정 메뉴">
                            <span class="ctrl-icon">⚙️</span>
                            <span class="ctrl-text">설정</span>
                        </button>
                        <div id="settingsDropdownMenu" class="settings-dropdown-menu hidden">
                            <button id="notificationBtn" class="dropdown-item" title="브라우저 알림 설정">
                                <span class="dropdown-icon">🔔</span>
                                <span>알림 설정</span>
                            </button>
                            <button id="logBtn" class="dropdown-item" title="시스템 로그 보기 (Ctrl+L)">
                                <span class="dropdown-icon">📋</span>
                                <span>로그 보기</span>
                            </button>
                            <button id="settingsBtn" class="dropdown-item" title="스캐너 설정">
                                <span class="dropdown-icon">⚙️</span>
                                <span>스캐너 설정</span>
                            </button>
                            <button id="helpBtn" class="dropdown-item" title="사용법 및 전략 안내">
                                <span class="dropdown-icon">💡</span>
                                <span>도움말</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>



        <!-- 실시간 돌파 종목 -->
        <section class="results-section">
            <h2>🚀 실시간 돌파 종목 (진입가 돌파 완료)</h2>
            <div id="breakoutStocks" class="stock-grid">
                <div class="no-results">스마트 스캔을 시작하여 돌파 종목을 찾아보세요!</div>
            </div>
        </section>

        <!-- 돌파 대기 종목 -->
        <section class="results-section">
            <h2>⏰ 돌파 대기 종목 (진입가 접근 중)</h2>
            <div id="waitingStocks" class="stock-grid">
                <div class="no-results">스마트 스캔을 시작하여 대기 종목을 찾아보세요!</div>
            </div>
        </section>


        <!-- 오프라인 표시 -->
        <div id="offlineIndicator" class="offline-indicator hidden">
            📡 오프라인 모드 - 캐시된 데이터 표시 중
        </div>
    </div>

    <!-- 설정 모달 -->
    <div id="settingsModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>⚙️ 스캐너 설정</h3>
                <button id="closeSettingsBtn" class="modal-close">✖️</button>
            </div>
            <div class="modal-body">
                <div class="settings-grid">
                    <!-- 스캔 필터 설정 -->
                    <div class="setting-section">
                        <h4>📊 스캔 필터 설정</h4>
                        <div class="setting-item">
                            <label for="volatilityRange">변동성 범위:</label>
                            <input type="range" id="volatilityRange" min="2" max="10" value="6" step="0.5" 
                                   title="스캔할 종목의 최대 변동성 한계 설정">
                            <span id="volatilityValue">2-6%</span>
                        </div>
                        <div class="setting-item">
                            <label for="minVolume">최소 거래량:</label>
                            <select id="minVolume" title="종목 필터링을 위한 최소 거래량">
                                <option value="500000">50만주</option>
                                <option value="1000000" selected>100만주</option>
                                <option value="2000000">200만주</option>
                                <option value="5000000">500만주</option>
                            </select>
                        </div>
                    </div>

                    <!-- 자동 업데이트 설정 -->
                    <div class="setting-section">
                        <h4>🔄 자동 업데이트 설정</h4>
                        <div class="setting-item">
                            <label for="autoUpdateEnabled">자동 업데이트:</label>
                            <div>
                                <input type="checkbox" id="autoUpdateEnabled" title="스캔 완료 후 자동으로 가격 업데이트 시작">
                                <span>스캔 후 자동 시작</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label for="updateInterval">업데이트 주기:</label>
                            <select id="updateInterval" title="자동 업데이트 간격 설정">
                                <option value="30">30초</option>
                                <option value="60" selected>1분</option>
                                <option value="120">2분</option>
                                <option value="300">5분</option>
                            </select>
                        </div>
                    </div>

                    <!-- 시스템 설정 -->
                    <div class="setting-section">
                        <h4>⚙️ 시스템 설정</h4>
                        <div class="setting-item">
                            <label>스캔 모드:</label>
                            <div>
                                <input type="checkbox" id="demoMode" title="데모 데이터 사용 (실제 API 키 없이 테스트)">
                                <span>데모 모드 (테스트용)</span>
                            </div>
                        </div>
                        <div class="setting-item">
                            <label for="notificationEnabled">브라우저 알림:</label>
                            <div>
                                <input type="checkbox" id="notificationEnabled" title="돌파 발생 시 브라우저 알림 표시">
                                <span>돌파 시 알림</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 도움말 모달 -->
    <div id="helpModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>💡 래리 윌리엄스 돌파 전략 & 사용법</h3>
                <button id="closeHelpBtn" class="modal-close">✖️</button>
            </div>
            <div class="modal-body">
                <!-- 전략 설명 -->
                <div style="background: rgba(59, 130, 246, 0.05); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                    <h4 style="margin: 0 0 10px 0; color: #3b82f6;">📚 전략 개요</h4>
                    <p><strong>핵심 원리:</strong> 횡보 후 변동성 돌파를 이용한 단기 매매 전략</p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>진입 조건:</strong> 전일 종가 + (전일 고가 - 전일 저가) × 0.6</li>
                        <li><strong>선별 조건:</strong> 2-8% 변동성, 100만주 이상 거래량, 횡보 패턴</li>
                        <li><strong>리스크 관리:</strong> 진입가 대비 -5% 손절, +2%/+5% 목표가</li>
                        <li><strong>추가 필터:</strong> 거래량 증가, 저항선 근처, 상승 추세</li>
                    </ul>
                </div>

                <!-- 사용법 -->
                <div style="background: rgba(16, 185, 129, 0.05); padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                    <h4 style="margin: 0 0 10px 0; color: #10b981;">🚀 사용 방법</h4>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li><strong>워치리스트 생성:</strong> 전날 데이터로 돌파 대기 종목 선별</li>
                        <li><strong>실시간 추적:</strong> 장중에 미리 계산된 진입가 돌파 감지</li>
                        <li><strong>자동 알림:</strong> 돌파 즉시 브라우저 알림 + 모의 주문</li>
                    </ol>
                    
                    <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(16, 185, 129, 0.2);">
                        <p><strong>🔗 단축키:</strong> Ctrl+Enter (또는 Cmd+Enter)로 전체 스캔 시작</p>
                        <p><strong>📋 로그:</strong> Ctrl+L (또는 Cmd+L)로 실시간 로그 확인</p>
                        <p><strong>🎭 데모 모드:</strong> 실제 API 없이도 전체 시스템 테스트 가능</p>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Loading overlay (초기화 중 표시) -->
    <div id="loadingOverlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        backdrop-filter: blur(5px);
    ">
        <div style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">📈</div>
            <div style="font-size: 1.2rem; color: #2563eb;">S&P 500 스캐너 초기화 중...</div>
        </div>
    </div>

    <!-- 스크립트 로드 순서 중요 -->
    <script src="js/logger.js"></script> <!-- 로그 시스템 (가장 먼저 로드) -->
    <script src="js/storage.js"></script>
    <script src="js/calculator.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/api-manager.js"></script> <!-- API 관리자 (Alpha Vantage 제한 해결) -->
    <script src="js/smart-scanner.js"></script> <!-- 스마트 스캐너 (효율적 스캔 전략) -->
    <script src="js/scanner.js"></script>
    <script src="js/breakout-tracker.js"></script> <!-- 새로운 돌파 추적 시스템 -->
    <script src="js/app.js"></script>
    
    <!-- 초기화 완료 후 로딩 오버레이 제거 -->
    <script>
        // 초기화 완료를 확인하고 로딩 오버레이 제거
        const checkInitialization = () => {
            if (window.sp500App && window.sp500App.isReady()) {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.opacity = '0';
                    overlay.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => {
                        overlay.remove();
                    }, 500);
                }
            } else {
                setTimeout(checkInitialization, 100);
            }
        };

        // 스크롤 시 컨트롤 네비게이션 컴팩트 모드
        let lastScrollTop = 0;
        const controlNavigation = document.querySelector('.control-navigation');
        
        const handleScroll = () => {
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            if (scrollTop > 50) {
                controlNavigation?.classList.add('compact');
            } else {
                controlNavigation?.classList.remove('compact');
            }
            
            lastScrollTop = scrollTop;
        };
        
        // 스크롤 이벤트 리스너 추가 (throttle 적용)
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            if (scrollTimeout) {
                cancelAnimationFrame(scrollTimeout);
            }
            scrollTimeout = requestAnimationFrame(handleScroll);
        });
        
        // DOM 로드 후 확인 시작
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkInitialization, 1000); // 1초 후부터 확인
        });
        
        // 최대 10초 후 강제 제거
        setTimeout(() => {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }, 10000);
    </script>

    <!-- 추가 초기화 스크립트 -->
    <script>
        // API 관리자 및 스마트 스캐너 통합 스크립트
        document.addEventListener('DOMContentLoaded', () => {
            // 초기화 완료 대기 후 시스템 설정
            setTimeout(() => {
                // 스마트 스캐너 초기화
                if (window.smartScanner) {
                    console.log('✅ 스마트 스캐너 사용 가능');
                }
                
                // 돌파 추적 시스템 설정
                if (typeof breakoutTracker !== 'undefined' && breakoutTracker) {
                    console.log('✅ 돌파 추적 시스템 사용 가능');
                    
                    // 기본 설정 적용
                    const demoModeCheck = document.getElementById('demoMode');
                    if (demoModeCheck) {
                        demoModeCheck.checked = false; // 데모 모드 기본 비활성화
                        demoModeCheck.addEventListener('change', (e) => {
                            if (window.stockScanner) {
                                window.stockScanner.demoMode = e.target.checked;
                                console.log(`데모 모드: ${e.target.checked ? 'ON' : 'OFF'}`);
                            }
                        });
                    }
                } else {
                    console.warn('⚠️ 돌파 추적 시스템을 찾을 수 없습니다.');
                }
                
                // API 관리자 요청 기록 로드
                if (window.apiManager) {
                    console.log('✅ API 관리자 사용 가능');
                    window.apiManager.loadRequestCounts();
                    console.log('📊 API 상태:', window.apiManager.getAPIStatus());
                }
                
                // 로그 시스템 초기화
                if (window.logger) {
                    console.log('✅ 로그 시스템 사용 가능');
                    
                    // 저장된 로그 불러오기
                    window.logger.loadFromStorage();
                    
                    // 설정 드롭다운 이벤트 바인딩
                    const settingsDropdownBtn = document.getElementById('settingsDropdownBtn');
                    const settingsDropdownMenu = document.getElementById('settingsDropdownMenu');
                    const settingsDropdown = document.querySelector('.settings-dropdown');
                    
                    if (settingsDropdownBtn && settingsDropdownMenu) {
                        settingsDropdownBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            settingsDropdownMenu.classList.toggle('hidden');
                            settingsDropdown.classList.toggle('active');
                        });
                        
                        // 드롭다운 외부 클릭시 닫기
                        document.addEventListener('click', () => {
                            settingsDropdownMenu.classList.add('hidden');
                            settingsDropdown.classList.remove('active');
                        });
                        
                        // 드롭다운 내부 클릭시 이벤트 전파 중지
                        settingsDropdownMenu.addEventListener('click', (e) => {
                            e.stopPropagation();
                        });
                    }
                    
                    // 개별 메뉴 아이템 이벤트 바인딩
                    const logBtn = document.getElementById('logBtn');
                    const settingsBtn = document.getElementById('settingsBtn');
                    const helpBtn = document.getElementById('helpBtn');
                    const notificationBtn = document.getElementById('notificationBtn');
                    
                    const settingsModal = document.getElementById('settingsModal');
                    const helpModal = document.getElementById('helpModal');
                    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
                    const closeHelpBtn = document.getElementById('closeHelpBtn');
                    
                    // 로그 버튼
                    if (logBtn) {
                        logBtn.addEventListener('click', () => {
                            window.logger.toggle();
                            settingsDropdownMenu.classList.add('hidden');
                            settingsDropdown.classList.remove('active');
                        });
                    }
                    
                    // 설정 모달
                    if (settingsBtn && settingsModal) {
                        settingsBtn.addEventListener('click', () => {
                            settingsModal.classList.remove('hidden');
                            settingsDropdownMenu.classList.add('hidden');
                            settingsDropdown.classList.remove('active');
                        });
                    }
                    
                    if (closeSettingsBtn && settingsModal) {
                        closeSettingsBtn.addEventListener('click', () => {
                            settingsModal.classList.add('hidden');
                        });
                    }
                    
                    // 도움말 모달
                    if (helpBtn && helpModal) {
                        helpBtn.addEventListener('click', () => {
                            helpModal.classList.remove('hidden');
                            settingsDropdownMenu.classList.add('hidden');
                            settingsDropdown.classList.remove('active');
                        });
                    }
                    
                    if (closeHelpBtn && helpModal) {
                        closeHelpBtn.addEventListener('click', () => {
                            helpModal.classList.add('hidden');
                        });
                    }
                    
                    
                    // 알림 설정 (기존 기능 유지)
                    if (notificationBtn) {
                        notificationBtn.addEventListener('click', () => {
                            // 기존 알림 설정 로직
                            settingsDropdownMenu.classList.add('hidden');
                            settingsDropdown.classList.remove('active');
                        });
                    }
                    
                    // 모달 외부 클릭시 닫기
                    [settingsModal, helpModal].forEach(modal => {
                        if (modal) {
                            modal.addEventListener('click', (e) => {
                                if (e.target === modal) {
                                    modal.classList.add('hidden');
                                }
                            });
                        }
                    });
                    
                    // 환영 메시지 (콘솔로만)
                    console.log('✅ S&P 500 스캐너가 성공적으로 초기화되었습니다');
                    console.log('📋 Ctrl+L (또는 Cmd+L)로 로그 패널을 열고 닫을 수 있습니다');
                }
                
            }, 2000);
        });
        
        function updateMarketStatus() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            const currentDay = now.getDay();
            
            const statusEl = document.getElementById('marketStatus');
            const iconEl = document.getElementById('marketStatusIcon');
            const textEl = document.getElementById('marketStatusText');
            
            if (!statusEl || !iconEl || !textEl) return; // 요소가 없으면 무시
            
            const isWeekend = currentDay === 0 || currentDay === 6;
            const isMarketHours = currentTime >= (9 * 60 + 30) && currentTime < (16 * 60);
            const isOpen = !isWeekend && isMarketHours;
            
            if (isOpen) {
                statusEl.className = 'market-status open';
                iconEl.textContent = '🟢';
                textEl.textContent = '장중 (US Market Open)';
            } else if (isWeekend) {
                statusEl.className = 'market-status closed';
                iconEl.textContent = '🔴';
                textEl.textContent = '주말 휴장';
            } else {
                statusEl.className = 'market-status closed';
                iconEl.textContent = '🟡';
                textEl.textContent = '장 마감';
            }
        }
        
        // DOM 로드 후 초기화
        document.addEventListener('DOMContentLoaded', () => {
            // 시장 상태 업데이트 (요소가 있을 때만)
            setTimeout(() => {
                updateMarketStatus();
                setInterval(updateMarketStatus, 60000); // 1분마다 업데이트
            }, 1000);
        });
    </script>

    <!-- PWA 서비스 워커 등록 -->
    <script>
        // 서비스 워커 등록 (HTTPS에서만)
        if ('serviceWorker' in navigator && location.protocol === 'https:') {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>

    <!-- Google Analytics (선택사항) -->
    <!--
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID');
    </script>
    -->
    
</body>
</html>